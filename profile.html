<!DOCTYPE html>
<html>
  <head>
    <title>User Profile</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial;
        background: #f4f4f4;
        padding: 30px;
      }

      .profile-box {
        width: 550px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        align-items: center;
      }

      .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        margin: auto;
        border: 3px solid #0d6efd;
      }

      .input-box {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
      }

      button {
        background: #0d6efd;
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <div class="profile-box">
      <h2 style="text-align: center">My Profile</h2>

      <img
        id="profile-pic-preview"
        class="profile-picture"
        src="default-profile.png"
      />

      <label><b>Change Photo</b></label>
      <input
        type="file"
        id="profile-photo"
        accept="image/*"
        class="input-box"
      />

      <label><b>Current Username</b></label>
      <input type="text" id="profile-username" class="input-box" disabled />

      <label><b>New Username</b></label>
      <input
        type="text"
        id="new-username"
        class="input-box"
        placeholder="Enter new username"
      />

      <label><b>Current Email</b></label>
      <input type="email" id="profile-email" class="input-box" disabled />

      <label><b>New Email</b></label>
      <input
        type="email"
        id="new-email"
        class="input-box"
        placeholder="Enter new email"
      />

      <label><b>New Password</b></label>
      <input
        type="password"
        id="new-password"
        class="input-box"
        placeholder="Enter new password"
      />

      <button id="save-profile-btn">Save Changes</button>

      <button
        id="delete-account"
        style="
          background: red;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        Delete Account
      </button>
    </div>

    <script>
      // Load user data
      let user =
        JSON.parse(localStorage.getItem("loggedInUser")) ||
        JSON.parse(localStorage.getItem("userAccount"));

      // Redirect if not logged in
      if (!user) {
        alert("You must be logged in to view your profile.");
        window.location.href = "login.html";
      }

      // Insert user info into fields
      document.getElementById("profile-pic-preview").src = user.photo
        ? user.photo
        : "default-profile.png";

      document.getElementById("profile-username").value = user.username
        ? user.username
        : "";

      document.getElementById("profile-email").value = user.email
        ? user.email
        : "";

      // Preview selected profile picture
      document
        .getElementById("profile-photo")
        .addEventListener("change", function () {
          let file = this.files[0];
          if (file) {
            let reader = new FileReader();
            reader.onload = () => {
              document.getElementById("profile-pic-preview").src =
                reader.result;
            };
            reader.readAsDataURL(file);
          }
        });

      document.getElementById("save-profile-btn").onclick = () => {
        // Update fields
        user.username = document.getElementById("profile-username").value;
        user.email = document.getElementById("profile-email").value;
        user.password = document.getElementById("profile-password").value;

        let file = document.getElementById("profile-photo").files[0];

        if (file) {
          let reader = new FileReader();
          reader.onload = () => {
            user.photo = reader.result;

            // Save updates to BOTH locations
            localStorage.setItem("loggedInUser", JSON.stringify(user));
            localStorage.setItem("userAccount", JSON.stringify(user));

            alert("Profile updated!");
          };
          reader.readAsDataURL(file);
        } else {
          // Save without new photo
          localStorage.setItem("loggedInUser", JSON.stringify(user));
          localStorage.setItem("userAccount", JSON.stringify(user));

          alert("Profile updated!");
        }
      };

      // Delete account
      document
        .getElementById("delete-account")
        .addEventListener("click", function () {
          if (
            !confirm(
              "Are you sure you want to delete your account? This action cannot be undone."
            )
          ) {
            return;
          }

          // Try to determine current user's identifying value (email or username)
          const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
          const currentUserEmail = localStorage.getItem("currentUser"); // from multi-user system
          const storedAccount = JSON.parse(localStorage.getItem("userAccount"));

          // Prefer email if available, otherwise fall back to username
          const identifier =
            (loggedInUser && (loggedInUser.email || loggedInUser.username)) ||
            currentUserEmail ||
            (storedAccount && (storedAccount.email || storedAccount.username));

          // 1) Remove from users array (if using multi-account system)
          let users = JSON.parse(localStorage.getItem("users")) || [];
          if (users.length && identifier) {
            users = users.filter((u) => {
              // compare by email if available, else by username
              if (identifier.includes("@")) {
                return u.email !== identifier;
              }
              return u.username !== identifier;
            });
            localStorage.setItem("users", JSON.stringify(users));
          }

          // 2) Remove single-account keys if they match the current user
          try {
            const ua = JSON.parse(localStorage.getItem("userAccount"));
            if (ua && identifier) {
              if (
                (ua.email && ua.email === identifier) ||
                (ua.username && ua.username === identifier)
              ) {
                localStorage.removeItem("userAccount");
              }
            }
          } catch (e) {}

          try {
            const lu = JSON.parse(localStorage.getItem("loggedInUser"));
            if (lu && identifier) {
              if (
                (lu.email && lu.email === identifier) ||
                (lu.username && lu.username === identifier)
              ) {
                localStorage.removeItem("loggedInUser");
              }
            }
          } catch (e) {}

          // remove other session keys
          localStorage.removeItem("currentUser");
          localStorage.removeItem("isLoggedIn");

          // 3) If there are any other user-like keys you use, remove them here:
          // localStorage.removeItem("someOtherUserKey");

          // Notify other tabs/scripts if needed
          try {
            window.dispatchEvent(new Event("userStatusChanged"));
            // storage event doesn't fire in same tab; but other tabs will see the localStorage changes.
          } catch (e) {}

          alert("Your account has been deleted.");
          // Redirect to signup or login page
          window.location.href = "login.html";
        });
    </script>
  </body>
</html>
